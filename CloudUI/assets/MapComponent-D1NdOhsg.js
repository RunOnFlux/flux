import{l as v,s as W,i as K,a as q}from"./leaflet-core-jNE0Bq0j.js";import{l as H}from"./leaflet-cluster-0ODEUdTP.js";import{a as w}from"./http-BZQDkn3h.js";import{_ as Q,e as X}from"./index-QPPWK7xw.js";import{s as Y}from"./vue-core-CU9AIURn.js";import{L as ee}from"./LoadingSpinner-BLJvP0iy.js";import{V as te}from"./vuetify-_4u1He_j.js";import{u as oe}from"./i18n-Bm8bpAAW.js";import{r as m,w as P,o as ae,n as z,c as ne,a as ie,P as A,g as _,Q as se,j as I,f as le,x as F,U as re,y as B,q as ue}from"./apexcharts-nIAyciCq.js";const ce={class:"v-map-wrapper"},de={key:0,class:"tier-label"},fe={__name:"MapComponent",props:{nodes:{type:Array,default:()=>[]},showAll:{type:Boolean,default:!0},filterNodes:{type:Array,default:()=>[]},showTierDisplay:{type:Boolean,default:!0}},setup(C){const n=C,{t:D}=oe(),{theme:k}=Y(X()),g=m(null),c=m([]),f=m([]),N=m(!0),M=m(!1);let i=null,d=null,h=null;const O=v.icon({iconUrl:q,iconRetinaUrl:K,shadowUrl:W,iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});function G(e,o={}){const t="https://",a="node.api.runonflux.io",u={api:0,home:-1},l=o.urlType||"api",[s,r]=e.includes(":")?e.split(":"):[e,"16127"],p=+r+u[l],x=s.replace(/\./g,"-");return`${t}${x}-${p}.${a}`}function j(e){return e.includes(":")?e.split(":")[0]:e}async function S(e){try{const o=j(e),t=await w.get(`https://ipapi.co/${o}/json/`);if(t.status===200)return{lat:t.data.latitude,lon:t.data.longitude,org:t.data.org||"Unknown"}}catch(o){console.error("ðŸ”´ GeoIP lookup failed for",e,o)}return null}async function b(){const e="https://stats.runonflux.io/fluxinfo?projection=geolocation,ip,tier";try{const o=await w.get(e);if(o.status===200&&o.data.status==="success")return o.data.data}catch(o){console.error("Error fetching nodes:",o)}return[]}function E(e){return e.includes(":")?`http://${e}/flux/nodetier`:`http://${e}:16127/flux/nodetier`}function R(e){return typeof e!="string"?"UNKNOWN":(e.includes("_")?e.split("_")[0]:e).toUpperCase()}async function V(){const e=c.value;let o=n.showAll?[...e,...f.value]:e.filter(a=>n.filterNodes.includes(a.ip)),t=n.showAll?[]:n.filterNodes.filter(a=>!o.some(u=>u.ip===a));if(!n.showAll&&t.length===0&&o.length===0&&(t=n.filterNodes),t.length>0)for(const a of t){if(e.some(l=>l.ip===a)||f.value.some(l=>l.ip===a))continue;const u=`${G(a)}/flux/info`;try{const l=await w.get(u,{timeout:5e3});if(l.data.status==="success"&&l.data.data?.node){const s=l.data.data;if(!s.geolocation){console.warn(`âš ï¸ No geolocation from node, trying GeoIP for ${a}`);const r=await S(a);r&&(s.geolocation={lat:r.lat,lon:r.lon,org:r.org})}if(s.geolocation){const r={ip:s.node.status.ip,tier:s.node.status.tier,geolocation:s.geolocation};f.value.push(r),o.push(r)}else console.warn(`âš ï¸ Still no geolocation for IP: ${a}`)}}catch{const[s,r]=await Promise.allSettled([S(a),w.get(E(a),{timeout:5e3})]),p=s.status==="fulfilled"?s.value:null,x=r.status==="fulfilled"?R(r.value.data?.data):"UNKNOWN";if(p){const U={ip:a,tier:x,geolocation:{lat:p.lat,lon:p.lon,org:p.org}};f.value.push(U),o.push(U)}else console.warn(`âš ï¸ GeoIP fallback also failed for IP: ${a}`)}}return n.showAll?[...e,...f.value]:o}function Z(e){const o=e.map(t=>{const a=parseFloat(t.geolocation?.lat),u=parseFloat(t.geolocation?.lon);return isNaN(a)||isNaN(u)?(console.warn(`âš ï¸ Skipping node with invalid geolocation: ${t.ip}`,t.geolocation),null):{type:"Feature",geometry:{type:"Point",coordinates:[u,a]},properties:{ip:t.ip||"Unknown",tier:t.tier||"Unknown",org:t.geolocation?.org||"Unknown"}}}).filter(Boolean);return v.geoJSON({type:"FeatureCollection",features:o},{pointToLayer:(t,a)=>v.marker(a,{icon:O}),onEachFeature:(t,a)=>{const{ip:u,tier:l,org:s}=t.properties;a.bindPopup(`IP: ${u}<br>Tier: ${l}<br>ISP: ${s}`)}})}async function $(){if(!i||!d)return;const e=await V(),o=Z(e);d.clearLayers(),d.addLayer(o);const t=o.getBounds();t.isValid()&&i.fitBounds(t,{padding:[50,50],maxZoom:5})}function T(){if(i){const e=k.value==="dark";i.getContainer().classList.toggle("leaflet-dark",e)}}function J(){if(!g.value)return;i=v.map(g.value,{center:[20,0],zoom:2,minZoom:2,maxZoom:18,attributionControl:!1}),v.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"Â© OpenStreetMap contributors",maxZoom:18,detectRetina:!0}).addTo(i),d=new H.MarkerClusterGroup({chunkedLoading:!0,chunkDelay:50,maxClusterRadius:80,spiderfyOnMaxZoom:!0}),i.addLayer(d),T(),i.invalidateSize()}const y=m(n.nodes!==void 0);P(()=>n.nodes,e=>{y.value&&e&&e.length>0&&(c.value=e,i&&d&&$())},{immediate:!0}),ae(async()=>{c.value.length||(n.nodes&&n.nodes.length>0?c.value=n.nodes:n.filterNodes&&n.filterNodes.length>0?(y.value=!1,c.value=await b()):n.showAll&&n.nodes===void 0?(y.value=!1,c.value=await b()):n.nodes!==void 0||(y.value=!1,c.value=await b())),await z(),J(),await $(),setTimeout(()=>{N.value=!1,z(()=>{i&&i.invalidateSize()})},500),g.value&&(h=new ResizeObserver(()=>{i&&i.invalidateSize()}),h.observe(g.value)),setTimeout(()=>{i&&i.invalidateSize()},500),M.value=!0}),P(k,()=>{T()});const L=ne(()=>{const e={},o=n.showAll?[...c.value,...f.value]:[...c.value,...f.value].filter(t=>n.filterNodes.includes(t.ip));for(const t of o)t.tier&&(e[t.tier]=(e[t.tier]||0)+1);return Object.keys(e).length?Object.entries(e).map(([t,a])=>`${t}: ${a}`).join(", "):""});return ie(()=>{h&&(h.disconnect(),h=null),i&&(i.remove(),i=null),d&&(d.clearLayers(),d=null)}),(e,o)=>(_(),A(te,{class:ue({"dark-theme":B(k).value==="dark"})},{default:se(()=>[I("div",ce,[I("div",{ref_key:"mapContainer",ref:g,style:{height:"450px",width:"100%"}},null,512),!N.value&&L.value&&C.showTierDisplay?(_(),le("div",de,re(L.value),1)):F("",!0),N.value?(_(),A(ee,{key:1,icon:"mdi-map-marker-multiple","icon-size":"40",title:B(D)("core.mapComponent.loading"),"title-class":"text-h3 font-weight-bold mb-3",class:"map-loading-overlay"},null,8,["title"])):F("",!0)])]),_:1},8,["class"]))}},be=Q(fe,[["__scopeId","data-v-a5376024"]]);export{be as _};
